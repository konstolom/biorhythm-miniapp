<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ë–∏–æ—Ä–∏—Ç–º—ã ¬∑ Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --pad:16px; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f6f7fb;color:#111}
    .container{max-width:720px;margin:0 auto;padding:var(--pad)}
    .card{background:#fff;border-radius:16px;padding:var(--pad);box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:var(--pad)}
    h1,h2,h3{margin:0 0 10px}
    label{display:block;margin:10px 0 6px}
    input,button{width:100%}
    input{padding:12px;border-radius:10px;border:1px solid #ddd}
    button{padding:12px 16px;border:0;border-radius:12px;font-weight:600;background:#2ea6ff;color:#fff;cursor:pointer}
    .row{display:flex;gap:12px}
    .row > div{flex:1}
    .hidden{display:none}
    .ok{color:#1a7f37;font-weight:600}
    .err{color:#b91c1c;font-weight:600}
    header, footer{display:flex;align-items:center;justify-content:space-between;padding:8px 0}
    header .left, header .right{font-size:14px;opacity:.9}
    header .left b{cursor:pointer}
    .menu{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:560px){ .menu{grid-template-columns:1fr 1fr}}
    .menu button{background:#fff;color:#111;border:1px solid #eee}
    .menu button:hover{box-shadow:0 4px 16px rgba(0,0,0,.08)}
    .muted{opacity:.8}
    .support{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .back{background:#fff;color:#111;border:1px solid #eee}
    .desc{white-space:pre-wrap;line-height:1.5}
    .tag{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;margin-left:8px}
  </style>
</head>
<body>
<div class="container">

  <!-- AUTH -->
  <section id="auth" class="card">
    <h2>–í—Ö–æ–¥</h2>
    <p class="muted">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∞—à–∏–º –±–∏–æ—Ä–∏—Ç–º–∞–º –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è</p>
    <label>–í–∞—à email</label>
    <input id="email" type="email" placeholder="you@example.com" />
    <label>–í–∞—à–∞ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
    <input id="dob" type="date" />
    <button id="login">–í–æ–π—Ç–∏</button>
    <p id="auth_status"></p>
  </section>

  <!-- HOME -->
  <section id="home" class="hidden">
    <header>
      <div class="left"><b id="profileBtn">–ø—Ä–æ—Ñ–∏–ª—å</b></div>
      <div class="right"><span id="userName">‚Äî</span><span class="tag" id="userDob">‚Äî</span></div>
    </header>

    <div class="card">
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –∏–∑—É—á–∏—Ç—å</h2>
      <div class="menu" style="margin-top:12px">
        <button id="btnYear">–ë–∏–æ—Ä–∏—Ç–º—ã 2025 –≥–æ–¥–∞</button>
        <button disabled>–ë–∏–æ—Ä–∏—Ç–º—ã –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled>–§–∏—Ç–æ—Ç–µ—Ä–∞–ø–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled>–ú–∏–Ω–µ—Ä–∞–ª—ã –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled>–í–∏—Ç–∞–º–∏–Ω—ã –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled>–≠—Ñ–∏—Ä–Ω—ã–µ –º–∞—Å–ª–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled>–ë–ê–î—ã –ø–æ –º–µ—Å—è—Ü–∞–º</button>
      </div>
    </div>

    <footer class="support card">
      <div class="muted">–í–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∏–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã?</div>
      <a href="https://t.me/konstolom" target="_blank" rel="noopener">
        <button>–¢–µ—Ö.–ø–æ–¥–¥–µ—Ä–∂–∫–∞</button>
      </a>
    </footer>
  </section>

  <!-- YEAR PAGE -->
  <section id="year" class="hidden">
    <header>
      <button class="back" id="backHome">–ù–∞–∑–∞–¥</button>
      <div class="right"><span id="userName2">‚Äî</span><span class="tag" id="userDob2">‚Äî</span></div>
    </header>

    <div class="card">
      <h2 id="yearTitle">–í–∞—à –±–∏–æ—Ä–∏—Ç–º 2025 –≥–æ–¥–∞ = ‚Äî</h2>
      <div id="yearDesc" class="desc muted" style="margin-top:8px"></div>
    </div>
  </section>

</div>

<!-- –ø–æ–¥–∫–ª—é—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ -->
<script src="/data.js"></script>

<!-- –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
<script>
const tg = window.Telegram?.WebApp; tg?.expand?.();
const STATE = { user: null, data: null };

function el(id){ return document.getElementById(id); }
function show(id){ for (const s of ['auth','home','year']) el(s).classList.add('hidden'); el(id).classList.remove('hidden'); }
function fmtDob(iso){ if(!iso) return '‚Äî'; const [Y,M,D] = iso.slice(0,10).split('-'); return `${D}.${M}.${Y}`; }
function reduceTo22(n){ while(n > 22){ n = String(n).split('').reduce((a,b)=>a + Number(b), 0);} return n; }
function computeGeneral2025(dobIso){ const [Y,M,D] = dobIso.slice(0,10).split('-').map(Number); return reduceTo22(D + M + 9); }

async function loadData(){
  if (STATE.data) return STATE.data;
  if (!window.APP_DATA) throw new Error('APP_DATA not found');
  STATE.data = window.APP_DATA;
  return STATE.data;
}

async function verify(email, dobIso){
  const r = await fetch(`/api/verify?email=${encodeURIComponent(email)}&dob=${encodeURIComponent(dobIso)}`);
  return r.json();
}

el('login').onclick = async () => {
  const email = el('email').value.trim().toLowerCase();
  const dob = el('dob').value;
  const st = el('auth_status');
  if(!email || !dob){ st.textContent='–í–≤–µ–¥–∏—Ç–µ e-mail –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è'; st.className='err'; return; }
  st.textContent='–ü—Ä–æ–≤–µ—Ä—è–µ–º...'; st.className='';

  try{
    const data = await verify(email, dob);
    if(!data.ok){ st.textContent = data.error || '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'; st.className='err'; return; }

    STATE.user = { email: data.user?.email || email, name: data.user?.name || '–ë–µ–∑ –∏–º–µ–Ω–∏', dob: (data.user?.dob || dob).slice(0,10) };
    el('userName').textContent = STATE.user.name;
    el('userDob').textContent = fmtDob(STATE.user.dob);

    show('home');
    tg?.MainButton?.hide?.();
  }catch(e){ st.textContent='–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'; st.className='err'; }
};

el('btnYear').onclick = async () => {
  try {
    el('userName2').textContent = STATE.user?.name || '‚Äî';
    el('userDob2').textContent  = fmtDob(STATE.user?.dob);

    const num = computeGeneral2025(STATE.user.dob);
    el('yearTitle').textContent = `–í–∞—à –±–∏–æ—Ä–∏—Ç–º 2025 –≥–æ–¥–∞ = ${num}`;

    const DATA = await loadData();
    const desc = DATA?.GENERAL?.[String(num)] || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
    el('yearDesc').textContent = desc;

    show('year');
  } catch (err) {
    console.error('btnYear error:', err);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–∞–∑–¥–µ–ª–∞. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.');
  }
};

el('backHome').onclick = () => show('home');
el('profileBtn').onclick = () => alert('–ü—Ä–æ—Ñ–∏–ª—å –¥–æ–±–∞–≤–∏–º –≤ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ üòä');
</script>
</body>
</html>



