<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ë–∏–æ—Ä–∏—Ç–º—ã ¬∑ Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --pad:16px; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f6f7fb;color:#111}
    .container{max-width:720px;margin:0 auto;padding:var(--pad)}
    .card{background:#fff;border-radius:16px;padding:var(--pad);box-shadow:0 2px 12px rgba(0,0,0,.06);margin-bottom:var(--pad)}
    h1,h2,h3{margin:0 0 10px}
    label{display:block;margin:10px 0 6px}
    input,button,select{width:100%}
    /* —Å–µ–ª–µ–∫—Ç—ã –¥–∞—Ç—ã ‚Äî –±–æ–ª—å—à–∏–µ –∏ —É–¥–æ–±–Ω—ã–µ */
    .date-row{display:flex;gap:8px}
    .date-row select{flex:1;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:16px}
    input{padding:12px;border-radius:10px;border:1px solid #ddd;font-size:16px}
    /* –∫–Ω–æ–ø–∫–∏ */
    button{padding:14px 18px;border:0;border-radius:14px;font-weight:700;font-size:16px;line-height:1.2;cursor:pointer;background:#2ea6ff;color:#fff;display:inline-flex;align-items:center;justify-content:center;gap:10px}
    button .ico{font-size:20px;line-height:1}
    /* —Å–µ—Ç–∫–∞ –º–µ–Ω—é */
    .menu{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:560px){ .menu{grid-template-columns:1fr 1fr}}
    .menu button{background:#fff;color:#111;border:1px solid #eee}
    .menu button:hover{box-shadow:0 4px 16px rgba(0,0,0,.08)}
    .hidden{display:none}
    .ok{color:#1a7f37;font-weight:600}
    .err{color:#b91c1c;font-weight:600}
    .muted{opacity:.8}
    /* –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ö–µ–¥–µ—Ä */
    header{display:flex;align-items:center;justify-content:space-between;padding:8px 0;gap:12px;flex-wrap:wrap}
    header .left{display:flex;align-items:center;gap:8px}
    header .right{margin-left:auto;display:flex;align-items:center;gap:8px;flex:1;justify-content:flex-end;min-width:0}
    header .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
    .back{background:#fff;color:#111;border:1px solid #eee;padding:10px 14px;border-radius:12px;font-weight:600}
    /* –∞–±–∑–∞—Ü—ã –æ–ø–∏—Å–∞–Ω–∏–π */
    .desc p{margin:0 0 12px 0;text-indent:1.5em}
    .tag{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px}
    /* —Ñ—É—Ç–µ—Ä –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π */
    .support{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .support .msg{
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
      overflow:hidden;max-width:70%;
    }
    .support .btn{background:#2ea6ff;color:#fff}
    /* –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ —Å—Ç—Ä–æ–∫—É */
    .result-row{
      display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:nowrap
    }
    .result-title{font-weight:800;font-size:20px}
    .result-pill{
      display:inline-block;font-weight:800;
      padding:10px 18px;border:3px solid #2ea6ff;border-radius:14px;color:#2ea6ff;
      font-size:28px;line-height:1
    }
    @media (min-width:560px){
      .result-title{font-size:22px}
      .result-pill{font-size:32px}
    }
  </style>
</head>
<body>
<div class="container">

  <!-- AUTH -->
  <section id="auth" class="card">
    <h2>–í—Ö–æ–¥</h2>
    <p class="muted">–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∞—à–∏–º –±–∏–æ—Ä–∏—Ç–º–∞–º –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è</p>

    <label>–í–∞—à email</label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email" />

    <label>–í–∞—à–∞ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
    <div class="date-row" aria-label="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
      <select id="dobDay" aria-label="–î–µ–Ω—å"></select>
      <select id="dobMonth" aria-label="–ú–µ—Å—è—Ü"></select>
      <select id="dobYear" aria-label="–ì–æ–¥"></select>
    </div>

    <!-- –ë–û–õ–¨–®–ò–ô –û–¢–°–¢–£–ü –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π -->
    <div style="height:16px"></div>
    <button id="login"><span class="ico">üîì</span>–í–æ–π—Ç–∏</button>
    <p id="auth_status"></p>
  </section>

  <!-- HOME -->
  <section id="home" class="hidden">
    <header>
      <div class="left">
        <button class="back" id="profileBtn" title="–ü—Ä–æ—Ñ–∏–ª—å"><span class="ico">üë§</span>–ø—Ä–æ—Ñ–∏–ª—å</button>
      </div>
      <div class="right">
        <span class="name" id="userName">‚Äî</span>
        <span class="tag" id="userDob">‚Äî</span>
      </div>
    </header>

    <div class="card">
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–µ–ª–∏ –±—ã –∏–∑—É—á–∏—Ç—å</h2>
      <div class="menu" style="margin-top:12px">
        <button id="btnYear"><span class="ico">üóìÔ∏è</span>–ë–∏–æ—Ä–∏—Ç–º—ã 2025 –≥–æ–¥–∞</button>
        <button disabled><span class="ico">üìÜ</span>–ë–∏–æ—Ä–∏—Ç–º—ã –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled><span class="ico">üåø</span>–§–∏—Ç–æ—Ç–µ—Ä–∞–ø–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled><span class="ico">ü™®</span>–ú–∏–Ω–µ—Ä–∞–ª—ã –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled><span class="ico">üíä</span>–í–∏—Ç–∞–º–∏–Ω—ã –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled><span class="ico">üß¥</span>–≠—Ñ–∏—Ä–Ω—ã–µ –º–∞—Å–ª–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</button>
        <button disabled><span class="ico">üß™</span>–ë–ê–î—ã –ø–æ –º–µ—Å—è—Ü–∞–º</button>
      </div>
    </div>

    <footer class="support card">
      <div class="muted msg">–í–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∏–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã?</div>
      <a href="https://t.me/konstolom" target="_blank" rel="noopener">
        <button class="btn"><span class="ico">üÜò</span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
      </a>
    </footer>
  </section>

  <!-- YEAR PAGE -->
  <section id="year" class="hidden">
    <header>
      <div class="left">
        <button class="back" id="backHome"><span class="ico">‚¨ÖÔ∏è</span>–ù–∞–∑–∞–¥</button>
      </div>
      <div class="right">
        <span class="name" id="userName2">‚Äî</span>
        <span class="tag" id="userDob2">‚Äî</span>
      </div>
    </header>

    <!-- –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É -->
    <div class="card" style="text-align:center">
      <div class="result-row">
        <div class="result-title">–í–∞—à –±–∏–æ—Ä–∏—Ç–º 2025 –≥–æ–¥–∞</div>
        <div id="yearNumber" class="result-pill">‚Äî</div>
      </div>
    </div>

    <!-- –±–ª–æ–∫ –æ–ø–∏—Å–∞–Ω–∏—è -->
    <div class="card">
      <div id="yearDesc" class="desc"></div>
    </div>

    <!-- —Ç–∞–∫–æ–π –∂–µ —Ñ—É—Ç–µ—Ä -->
    <footer class="support card">
      <div class="muted msg">–í–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∏–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã?</div>
      <a href="https://t.me/konstolom" target="_blank" rel="noopener">
        <button class="btn"><span class="ico">üÜò</span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
      </a>
    </footer>
  </section>

</div>

<!-- –¥–∞–Ω–Ω—ã–µ -->
<script src="/data.js"></script>

<!-- –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
<script>
const tg = window.Telegram?.WebApp; tg?.expand?.();
const STATE = { user: null, data: null };

function el(id){ return document.getElementById(id); }
function show(id){ for (const s of ['auth','home','year']) el(s).classList.add('hidden'); el(id).classList.remove('hidden'); }
function fmtDob(iso){ if(!iso) return '‚Äî'; const [Y,M,D] = iso.slice(0,10).split('-'); return `${D}.${M}.${Y}`; }
function reduceTo22(n){ while(n > 22){ n = String(n).split('').reduce((a,b)=>a + Number(b), 0);} return n; }
function computeGeneral2025(dobIso){ const [Y,M,D] = dobIso.slice(0,10).split('-').map(Number); return reduceTo22(D + M + 9); }

async function loadData(){
  if (STATE.data) return STATE.data;
  if (!window.APP_DATA) throw new Error('APP_DATA not found');
  STATE.data = window.APP_DATA;
  return STATE.data;
}

async function verify(email, dobIso){
  const initData = window.Telegram?.WebApp?.initData || '';
  const r = await fetch(`/api/verify?email=${encodeURIComponent(email)}&dob=${encodeURIComponent(dobIso)}`, {
    headers: { 'x-telegram-init-data': initData }
  });
  return r.json();
}

/* –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤ –¥–∞—Ç—ã */
(function initDOB(){
  const dd = el('dobDay'), mm = el('dobMonth'), yy = el('dobYear');
  dd.innerHTML = '<option value="" disabled selected>–î–µ–Ω—å</option>' +
    Array.from({length:31}, (_,i)=>`<option value="${String(i+1).padStart(2,'0')}">${i+1}</option>`).join('');
  const months = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
  mm.innerHTML = '<option value="" disabled selected>–ú–µ—Å</option>' +
    months.map((m,i)=>`<option value="${String(i+1).padStart(2,'0')}">${String(i+1).padStart(2,'0')} ‚Äî ${m}</option>`).join('');
  const thisYear = new Date().getFullYear();
  const startYear = 1930;
  yy.innerHTML = '<option value="" disabled selected>–ì–æ–¥</option>' +
    Array.from({length:thisYear-startYear+1}, (_,k)=>thisYear-k).map(y=>`<option value="${y}">${y}</option>`).join('');
})();

function getDOBISO(){
  const dd = el('dobDay').value;
  const mm = el('dobMonth').value;
  const yy = el('dobYear').value;
  if (!dd || !mm || !yy) return '';
  const d = new Date(Number(yy), Number(mm)-1, Number(dd));
  if (d.getFullYear() != yy || (d.getMonth()+1) != Number(mm) || d.getDate() != Number(dd)) return '';
  return `${yy}-${mm}-${dd}`;
}

/* —É—Ç–∏–ª–∏—Ç–∞: –¥–µ–ª–∏–º —Ç–µ–∫—Å—Ç –Ω–∞ 2‚Äì3 –∞–±–∑–∞—Ü–∞ –ø–æ —Å–º—ã—Å–ª—É */
function splitIntoParagraphs(text){
  // –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–∂–µ –µ—Å—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
  const partsByBreak = text.split(/\n{2,}/).map(s=>s.trim()).filter(Boolean);
  if (partsByBreak.length >= 2 && partsByBreak.length <= 4) return partsByBreak;

  // –∏–Ω–∞—á–µ –¥–µ–ª–∏–º –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º (–ø–æ—Å–ª–µ —Ç–æ—á–∫–∏)
  const sentences = text.split(/(?<=\.)\s+/).map(s=>s.trim()).filter(Boolean);
  if (sentences.length <= 3) {
    return [sentences.join(' ')];
  } else if (sentences.length <= 6) {
    const mid = Math.ceil(sentences.length/2);
    return [sentences.slice(0,mid).join(' '), sentences.slice(mid).join(' ')];
  } else {
    const third = Math.ceil(sentences.length/3);
    return [
      sentences.slice(0, third).join(' '),
      sentences.slice(third, third*2).join(' '),
      sentences.slice(third*2).join(' ')
    ];
  }
}

/* –ª–æ–≥–∏–Ω */
el('login').onclick = async () => {
  const email = el('email').value.trim().toLowerCase();
  const dobIso = getDOBISO();
  const st = el('auth_status');
  if(!email || !dobIso){ st.textContent='–í–≤–µ–¥–∏—Ç–µ e-mail –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è'; st.className='err'; return; }
  st.textContent='–ü—Ä–æ–≤–µ—Ä—è–µ–º...'; st.className='';

  try{
    const data = await verify(email, dobIso);
    if(!data.ok){ st.textContent = data.error || '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'; st.className='err'; return; }

    STATE.user = { email: data.user?.email || email, name: data.user?.name || '–ë–µ–∑ –∏–º–µ–Ω–∏', dob: (data.user?.dob || dobIso).slice(0,10) };
    el('userName').textContent = STATE.user.name;
    el('userDob').textContent = fmtDob(STATE.user.dob);

    show('home');
    tg?.MainButton?.hide?.();
  }catch(e){ st.textContent='–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'; st.className='err'; }
};

/* –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
el('btnYear').onclick = async () => {
  try {
    el('userName2').textContent = STATE.user?.name || '‚Äî';
    el('userDob2').textContent  = fmtDob(STATE.user?.dob);

    const num = computeGeneral2025(STATE.user.dob);
    el('yearNumber').textContent = num;

    const DATA = await loadData();
    let desc = DATA?.GENERAL?.[String(num)] || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
    const paragraphs = splitIntoParagraphs(desc);
    el('yearDesc').innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');

    show('year');
  } catch (err) {
    console.error('btnYear error:', err);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–∞–∑–¥–µ–ª–∞. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.');
  }
};

el('backHome').onclick = () => show('home');
el('profileBtn').onclick = () => alert('–ü—Ä–æ—Ñ–∏–ª—å –¥–æ–±–∞–≤–∏–º –≤ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ üòä');
</script>
</body>
</html>





